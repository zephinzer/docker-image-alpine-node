sudo: required
language: bash
services:
  - docker
branches:
  only:
    - master
env:
  global:
    - BUILD_VERSION=$(./scripts/versioning/get-next -q)
    - DOCKER_REPO='zephinzer/alpine-node'
    - NEXT_ARGON='next_argon'
    - NEXT_BORON='next_boron'
    - NEXT_CARBON='next_carbon'
    - TAG_ARGON='argon'
    - TAG_BORON='boron'
    - TAG_CARBON='carbon'
notifications:
  email:
    - ${NOTIFICATION_EMAIL}
stages:
  - build
  - test
  - publish
before_script:
  - docker login -u $DHUSER -p $DHPASS
after_script:
  - docker logout
jobs:
  include: # <codename>-<node_version>, <build_version>-<codename>, latest-<codename>
    - stage: build
      env:
        - building=argon
      script:
        - ./scripts/build/setup
        - NODE_VERSION=$(cat ./${TAG_ARGON}.Version);
        - docker build -t ${NEXT_ARGON} -f argon.Dockerfile .
        - docker tag ${NEXT_ARGON} ${DOCKER_REPO}:${NODE_VERSION}
        - docker push ${DOCKER_REPO}:${NODE_VERSION}
        - docker tag ${NEXT_ARGON} ${DOCKER_REPO}:${TAG_ARGON}-${NODE_VERSION}
        - docker push ${DOCKER_REPO}:${TAG_ARGON}-${NODE_VERSION}
        - docker tag ${NEXT_ARGON} ${DOCKER_REPO}:${BUILD_VERSION}-${TAG_ARGON}
        - docker push ${DOCKER_REPO}:${BUILD_VERSION}-${TAG_ARGON}
        - docker tag ${NEXT_ARGON} ${DOCKER_REPO}:latest-${TAG_ARGON}
        - docker push ${DOCKER_REPO}:latest-${TAG_ARGON}
        - ./scripts/build/teardown
    - stage: build
      env:
        - building=boron
      script:
        - ./scripts/build/setup
        - NODE_VERSION=$(cat ./${TAG_BORON}.Version);
        - docker build -t ${NEXT_BORON} -f boron.Dockerfile .
        - docker tag ${NEXT_BORON} ${DOCKER_REPO}:${TAG_BORON}-${NODE_VERSION}
        - docker push ${DOCKER_REPO}:${TAG_BORON}-${NODE_VERSION}
        - docker tag ${NEXT_BORON} ${DOCKER_REPO}:${BUILD_VERSION}-${TAG_BORON}
        - docker push ${DOCKER_REPO}:${BUILD_VERSION}-${TAG_BORON}
        - docker tag ${NEXT_BORON} ${DOCKER_REPO}:latest-${TAG_BORON}
        - docker push ${DOCKER_REPO}:latest-${TAG_BORON}
        - ./scripts/build/teardown
    - stage: build
      env:
        - building=carbon
      script:
        - ./scripts/build/setup
        - NODE_VERSION=$(cat ./${TAG_CARBON}.Version);
        - docker build -t ${NEXT_CARBON} -f carbon.Dockerfile .
        - docker tag ${NEXT_CARBON} ${DOCKER_REPO}:${TAG_CARBON}-${NODE_VERSION}
        - docker push ${DOCKER_REPO}:${TAG_CARBON}-${NODE_VERSION}
        - docker tag ${NEXT_CARBON} ${DOCKER_REPO}:${BUILD_VERSION}-${TAG_CARBON}
        - docker push ${DOCKER_REPO}:${BUILD_VERSION}-${TAG_CARBON}
        - docker tag ${NEXT_CARBON} ${DOCKER_REPO}:latest-${TAG_CARBON}
        - docker push ${DOCKER_REPO}:latest-${TAG_CARBON}
        - docker tag ${NEXT_CARBON} ${DOCKER_REPO}:latest
        - docker push ${DOCKER_REPO}:latest
        - ./scripts/build/teardown
    - stage: test
      script:
        - docker pull ${DOCKER_REPO}:latest-${TAG_ARGON}
        - docker build -f ./test/react/argon.Dockerfile -t test_argon .
        - docker run test_argon
    - stage: test
      script:
        - docker pull ${DOCKER_REPO}:latest-${TAG_BORON}
        - docker build -f ./test/react/boron.Dockerfile -t test_boron .
        - docker run test_boron
    - stage: test
      script:
        - docker pull ${DOCKER_REPO}:latest-${TAG_CARBON}
        - docker build -f ./test/react/carbon.Dockerfile -t test_carbon .
        - docker run test_carbon
    - stage: publish
      script:
        - git checkout ${TRAVIS_BRANCH}
        - git reset --hard ${TRAVIS_COMMIT}
        - ./scripts/versioning/iterate -i -q
        - git push -q https://zephinzer:${GITHUB_TOKEN}@github.com/zephinzer/docker-image-alpine-node.git --tags
        - git fetch origin
        - git checkout origin/release
        - git rebase ${TRAVIS_BRANCH}
        - git push -q https://zephinzer:${GITHUB_TOKEN}@github.com/zephinzer/docker-image-alpine-node.git
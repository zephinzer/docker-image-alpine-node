sudo: required
language: bash
services:
  - docker
branches:
  only:
    - master
env:
  global:
    - DOCKER_REPO='zephinzer/alpine-node'
notifications:
  email:
    - dev@joeir.net
script:
  - VERSION=$(./scripts/versioning/get-next -q)
  - docker build -t ${DOCKER_REPO}:next .
  - docker login -u $DHUSER -p $DHPASS
  - docker tag ${DOCKER_REPO}:next ${DOCKER_REPO}:${VERSION}
  - docker tag ${DOCKER_REPO}:${VERSION} ${DOCKER_REPO}:latest
  - docker push ${DOCKER_REPO}:${VERSION}
  - docker logout
after_success:
  - git checkout ${TRAVIS_BRANCH}
  - git reset --hard ${TRAVIS_COMMIT}
  - ./scripts/versioning/iterate -i -q
  - git push -q https://zephinzer:${GITHUB_TOKEN}@github.com/zephinzer/docker-image-alpine-node.git --tags
  - git fetch origin release
  - git checkout release
  - git rebase ${TRAVIS_BRANCH}
  - git push -q https://zephinzer:${GITHUB_TOKEN}@github.com/zephinzer/docker-image-alpine-node.git